---
title: "Taller 3 - Modelo Regresión Multinomial"
author:
  - name: "Jhon Tascon Velasco"
  - name: "Lino Sinisterra"
  - name: "Juan Chacon"
date: "2025-09-15"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(dplyr)
library(tidyverse)
library(plotly)
library(ggcorrplot)
library(foreign)
library(caret)
library(nnet)
library(ggplot2)
library(reshape2)
library(marginaleffects)
library(ResourceSelection)
library(knitr)
library(kableExtra)
```

## **0. Información general**

En este trabajo se identificarán qué factores inciden en la preferencia de modo de transporte: avión, tren, bus y carro.

Las variables a analizar son las siguientes:

```{r tabla_variables, echo=FALSE}
variables <- data.frame(
  Variables = c(
    "Tiempo_Espera",
    "Costo_Viaje",
    "Tiempo_Viaje",
    "Costo_Generalizado",
    "Ingresos_Hogar",
    "Tamano_Grupo",
    "Modo_Viaje"),
  Tipo_Variable = c(
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Ordinal",
    "Nominal/Variable objetivo"),
  Descripción = c(
    "Tiempo de espera en terminal",
    "Costo del viaje",
    "Tiempo de viaje",
    "Costo generalizado del viaje",
    "Ingresos del hogar",
    "Tamaño del grupo que viaja",
    "Modo de transporte")
)

kable(variables, format = "html", caption = "Descripción de variables del estudio", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, position = "center") %>%
  row_spec(nrow(variables), bold = TRUE)  
```

## **1. Análisis exploratorio**
```{r carga_datos, echo=FALSE}
df = read.csv("modos_viaje.csv", header=TRUE, sep=",")
```

### **1.1. Revisión de datos faltantes**
```{r nulos, echo=FALSE}
# Revisar si hay faltantes
nulos = colSums(is.na(df))

kable(nulos, caption = "Datos faltantes") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
Con base en la tabla anterior, no hay datos faltantes.

### **1.2. Resumen de las variables**
```{r descripcion, echo=FALSE}
# Convertir las variables cualitativas a factores
df$Tamano_Grupo = factor(
  df$Tamano_Grupo,
  ordered=TRUE
)

df$Modo_Viaje = factor(
  df$Modo_Viaje,
  ordered=FALSE
)

resumen = summary(df)
kable(resumen, caption = "Descripción del conjunto de datos") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
Analizar

```{r numericas, fig.width=10, fig.height=10, echo=FALSE, message=FALSE}
cat("\n")
# Crear boxplots con facetas
df_long = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar)

df_long = pivot_longer(
  df_long,
  cols = c(Tiempo_Espera,
          Costo_Viaje,
          Tiempo_Viaje,
          Costo_Generalizado,
          Ingresos_Hogar),
  names_to = "Variable",
  values_to = "Valor"
)

histogramas = ggplot(df_long, aes(x = Valor, fill = Variable)) +
  geom_histogram(bins=15) +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  labs(title="Histogramas de las variables numéricas")
histogramas

boxplots = ggplot(df_long, aes(y = Valor, fill = Variable)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  labs(title = "Boxplots de las variables numéricas")
boxplots
```
Poner hallazgos
```{r cualitativas, echo=FALSE}

cat("\n")
df_long = df %>%
  dplyr::select(Tamano_Grupo) %>%
  mutate(across(c(Tamano_Grupo),
                as.character)
          )

# Convertir a formato largo
df_long <- df_long %>%
  pivot_longer(cols = everything(),
  names_to = "Variable", values_to = "Categoria")

# Calcular proporciones
df_prop <- df_long %>%
  group_by(Variable, Categoria) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  group_by(Variable) %>%
  mutate(Proporcion = Frecuencia / sum(Frecuencia))

# Gráfico de barras con facetas
ggplot(df_prop, aes(x = Categoria, y = Proporcion, fill = Categoria)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Variable, scales = "free", ncol=3) +
  geom_text(aes(label = scales::percent(Proporcion, accuracy = 0.1)), 
            vjust = -0.5, size = 3) +
  theme_light() +
  theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 1)
    )
```

Poner hallazgos

### **1.3. Análisis bivariado**
```{r bivariado, echo=FALSE}

cat("\n")
df_long = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar,
                Modo_Viaje)


df_long <- df_long %>%
  pivot_longer(cols = c(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar),
               names_to = "Variable",
               values_to = "Valor")

# Crear el gráfico de boxplots
boxplots = ggplot(df_long, aes(x = Variable, y = Valor, fill = Modo_Viaje)) +
geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Distribución de las variables numéricas con el Modo de transporte")
boxplots
```

Poner hallazgos

```{r correlacion, echo=FALSE}
df_sel = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar)

# Calcula la matriz de correlación
corr_matrix = round(cor(df_sel), 2)

ggcorrplot(corr_matrix,
  lab = TRUE,             # Muestra los coeficientes de correlación en el gráfico
  type = "lower",         # Muestra solo la matriz triangular inferior
  outline.col = "white",  # Color del borde de los cuadrados
  ggtheme = ggplot2::theme_gray, # Tema de ggplot
  colors = c("#6D9EC1", "white", "#E46726") # Colores para correlaciones negativas, cero y positivas
) +
labs(title = "Matriz de Correlación")
```

Poner hallazgos

Si bien no se presentan asociacones muy fuertes entre variables, excepto para tiempo de espera y costo de viaje que tiene una correlación Pearson de 0.63, el Costo generalizado es una combinación lineal del tiempo de transporte y el costo de viaje, por lo tanto, se va a eliminar del análsisi para evitar una posible multicolinealidad. Además, revisando las relación entre variables, se evidencia que tiempos de espera en cero corresponden a los carros, por ende, puede sesgar el modelo. Por este motivo, tampoco se tendrá en cuenta dicha variable para el análisis.
```{r categoricas, echo=FALSE, message=FALSE}
barplots = ggplot(df, aes(x = Tamano_Grupo, fill = Modo_Viaje)) +
  geom_bar(position = "stack") +
  theme_minimal() +
  labs(title = "Relación entre Tamaño del grupo y Modo de transporte",
       x = "Tamaño del grupo",
       y = "Frecuencia")
barplots
```

Poner hallazgos

## **2. Modelo multinomial**
```{r modelo, fig.width=10, fig.height=10, echo=FALSE}
df = df_sel = df %>%
  dplyr::select(Costo_Viaje,
                Tiempo_Viaje,
                Ingresos_Hogar,
                Tamano_Grupo,
                Modo_Viaje)
modelo = multinom(Modo_Viaje ~ ., data = df)

# Coeficientes
cat("\nCoefientes")
summary(modelo)$coefficients

# Valores p
cat("\nP-values")
z = summary(modelo)$coefficients/summary(modelo)$standard.errors
p = (1 - pnorm(abs(z), 0, 1)) * 2
p
```

### **2.1. Análisis de los coeficientes y p-values**
Sale del summary del modelo, tener en cuenta el p-value

### **2.2. Odds Ratio**
```{r odds, fig.width=10, fig.height=10, echo=FALSE}
odds = exp(coef(modelo))
odds
```

Análisis de los odds

### **2.3. Análisis marginal**
```{r marginal, echo=FALSE}
marginals = avg_slopes(modelo)
kable(marginals, format = "html", caption = "Análisis marginal", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, position = "center")
```

Análisis marginal

### **2.4. Análisis de las predicciones**

```{r analisis_probs1, echo=FALSE}
vector_cv <- seq(from = min(df$Costo_Viaje, na.rm = TRUE),
                   to = max(df$Costo_Viaje, na.rm = TRUE),
                   length.out = 41)

vector_tv <- seq(from = min(df$Tiempo_Viaje, na.rm = TRUE),
                   to = max(df$Tiempo_Viaje, na.rm = TRUE),
                   length.out = 41)

vector_ing <- seq(from = min(df$Ingresos_Hogar, na.rm = TRUE),
                   to = max(df$Ingresos_Hogar, na.rm = TRUE),
                   length.out = 41)

df_sim <- data.frame(
  Tamano_Grupo = rep(c(1, 2, 3, 4, 5, 6), each = 41),
  Costo_Viaje = rep(vector_cv, 6),
  Tiempo_Viaje = rep(vector_tv, 6),
  Ingresos_Hogar = rep(vector_ing, 6)
)

df_sim$Tamano_Grupo = factor(
  df_sim$Tamano_Grupo,
  ordered=TRUE
)

## almacene las probabilidades predichas para cada valor de tamaño de grupo
pp.sim = cbind(df_sim, predict(modelo, newdata = df_sim, type = "probs", se = TRUE))

## calcular las probabilidades medias dentro de cada nivel de tamaño de grupo
cat("Probabilidades medias por cada nivel de tamaño de grupo")
by(pp.sim[, 5:8], pp.sim$Tamano_Grupo, colMeans)
```

Poner hallazgos
```{r analisis_probs2, echo=FALSE}
# Grafico probabilidades predichas
# Pasar la base a formato long para utilizar ggplot
cat("Gráfico de probabilidades")
lpp = melt(
  pp.sim,
  id.vars = c("Tamano_Grupo", "Costo_Viaje", "Tiempo_Viaje", "Ingresos_Hogar"),
  value.name = "probability"
)

ggplot(lpp, aes(x = Costo_Viaje, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Costo de Viaje")

ggplot(lpp, aes(x = Tiempo_Viaje, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Tiempo de Viaje")

ggplot(lpp, aes(x = Ingresos_Hogar, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Ingresos del hogar")
```

Poner hallazgos

### **2.5. Diagnóstico**
```{r diagnostico, echo=FALSE}

# 1. Pseudo R² (McFadden)
logLik_null = logLik(multinom(Modo_Viaje ~ 1, data = df))
logLik_modelo = logLik(modelo)
pseudo_r2 = 1 - (as.numeric(logLik_modelo) / as.numeric(logLik_null))
cat("Pseudo R²:", pseudo_r2, "\n")

# 2. Log-likelihood
cat("Log-likelihood:", logLik_modelo, "\n")

# 3. AIC y BIC
cat("AIC:", AIC(modelo), "\n")
cat("BIC:", BIC(modelo), "\n")


# 4. Matriz de confusión
cat("Matriz de confusión:")
predicciones = predict(modelo)
reporte = confusionMatrix(predicciones, df$Modo_Viaje)
matriz_confusion = reporte$table
matriz_df = melt(matriz_confusion)

# Visualización con ggplot2
ggplot(matriz_df, aes(x = Prediction, y = Reference, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value), size = 5) +
  scale_fill_gradient(low = "lightblue", high = "blue") +
  labs(title = "Matriz de Confusión - Modelo Multinomial",
       x = "Predicho", y = "Real") +
  theme_minimal()

# 5. Reporte de clasificación
cat("\nReporte de clasificación:")
kable(reporte$overall, caption = "Estadísticas generales") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

kable(t(reporte$byClass), caption = "Estadisticas por clase") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Poner hallazgos