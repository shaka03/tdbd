---
title: "Taller 3 - Modelo Regresión Multinomial"
author:
  - name: "Jhon Tascon Velasco"
  - name: "Lino Sinisterra"
  - name: "Juan Chacon"
date: "2025-09-15"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(dplyr)
library(tidyverse)
library(plotly)
library(ggcorrplot)
library(foreign)
library(caret)
library(nnet)
library(ggplot2)
library(reshape2)
library(marginaleffects)
library(ResourceSelection)
library(knitr)
library(kableExtra)
library(mlogit)
```

## **0. Información general**

En este trabajo se identificarán qué factores inciden en la preferencia de modo de transporte: Avión, Tren, Bus y Carro.

Este problema es idóneo para un modelo de regresión multinomial (MNL) porque:

-	La variable de respuesta, Modo_Viaje, es nominal. No hay un orden natural entre las categorías (el Avión no es inherentemente mejor o peor que el Carro, o el Tren es mejor o peor que Bus, entre otros escenarios ).

-	Hay más de dos categorías, lo que descarta el uso de modelos de regresión logística binaria.

-	La categoría base para la interpretación del modelo, según la ordenación alfabética por defecto de R, será Avión. Todas las comparaciones se realizarán con respecto a esta categoría de referencia.

-	Además, Se presta especial atención a la estructura de los datos: para atributos específicos por alternativa (tiempo, costo) es imprescindible conservar el formato long (una fila por alternativa por individuo) y una variable binaria Choice que indique la alternativa escogida.

Las variables a analizar son las siguientes:

```{r tabla_variables, echo=FALSE}
variables <- data.frame(
  Variables = c(
    "Tiempo_Espera",
    "Costo_Viaje",
    "Tiempo_Viaje",
    "Costo_Generalizado",
    "Ingresos_Hogar",
    "Tamano_Grupo",
    "Modo_Viaje"),
  Tipo_Variable = c(
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Cuantitativa",
    "Ordinal",
    "Nominal/Variable objetivo"),
  Descripción = c(
    "Tiempo de espera en terminal",
    "Costo del viaje",
    "Tiempo de viaje",
    "Costo generalizado del viaje",
    "Ingresos del hogar",
    "Tamaño del grupo que viaja",
    "Modo de transporte")
)

kable(variables, format = "html", caption = "Descripción de variables del estudio", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, position = "center") %>%
  row_spec(nrow(variables), bold = TRUE)  
```



## **1. Análisis exploratorio**
```{r carga_datos, echo=FALSE}
df = read.csv("modos_viaje.csv", header=TRUE, sep=",")
```

### **1.1. Revisión de datos faltantes**
```{r nulos, echo=FALSE}
# Revisar si hay faltantes
nulos = colSums(is.na(df))

kable(nulos, caption = "Datos faltantes") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

No se identificaron datos faltantes en el conjunto de datos, lo que permite un análisis completo sin necesidad de imputación.

### **1.2. Resumen de las variables**
```{r descripcion, echo=FALSE}
# Convertir las variables cualitativas a factores
df$Tamano_Grupo = factor(
  df$Tamano_Grupo,
  ordered=TRUE
)

df$Modo_Viaje = factor(
  df$Modo_Viaje,
  ordered=FALSE
)

resumen = summary(df)
kable(resumen, caption = "Descripción del conjunto de datos") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

***Conversión a factores:*** Las variables Tamano_Grupo y Modo_Viaje se convirtieron a factores. Se aclara que Tamano_Grupo es ordinal (los grupos tienen un orden de tamaño) y Modo_Viaje es nominal (sin orden).

***Hallazgos Clave:***
Existe una alta correlación entre Costo_Generalizado y (Costo_Viaje y Tiempo_Viaje), Costo_Generalizado es una variable compuesta de Costo_Viaje y Tiempo_Viaje, lo que genera una multicolinealidad perfecta que sesgaría el modelo. Por lo tanto, se eliminará esta variable. De forma similar.

```{r numericas, fig.width=10, fig.height=10, echo=FALSE, message=FALSE}
cat("\n")
# Crear boxplots con facetas
df_long = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar)

df_long = pivot_longer(
  df_long,
  cols = c(Tiempo_Espera,
          Costo_Viaje,
          Tiempo_Viaje,
          Costo_Generalizado,
          Ingresos_Hogar),
  names_to = "Variable",
  values_to = "Valor"
)

histogramas = ggplot(df_long, aes(x = Valor, fill = Variable)) +
  geom_histogram(bins=15) +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  labs(title="Histogramas de las variables numéricas")
histogramas

boxplots = ggplot(df_long, aes(y = Valor, fill = Variable)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  labs(title = "Boxplots de las variables numéricas")
boxplots
```

***Los histogramas permite observar que:***

  - Tiempo_Espera: La distribución de esta variable probablemente estará sesgada a la derecha, con la mayoría de los valores concentrados en tiempos de espera bajos y algunos viajes con tiempos de espera significativamente más largos.

  - Costo_Viaje: De manera similar, se espera una distribución sesgada a la derecha, con muchos viajes de bajo costo y una cola de viajes más caros (probablemente los aéreos).

  - Tiempo_Viaje: La distribución de esta variable podría ser bimodal, con un pico para los viajes cortos (en carro o bus) y otro para los viajes largos (en avión).

  - Ingresos_Hogar: La distribución de los ingresos suele estar sesgada positivamente, con la mayoría de los hogares en rangos de ingresos medios y bajos, y una pequeña fracción de hogares con ingresos muy altos.

***Los boxplots permite observar que:***

  - Modo_Viaje: Este gráfico mostrará la cantidad de individuos que prefieren cada modo de transporte. Podría haber un modo de transporte dominante.

  - Tamano_Grupo: Este gráfico revelará la frecuencia de cada tamaño de grupo (por ejemplo, 1, 2, 3 o más personas), lo que puede ser un factor relevante en la elección del medio de transporte (por ejemplo, los grupos grandes podrían preferir el carro).
```{r cualitativas, echo=FALSE}

cat("\n")
df_long = df %>%
  dplyr::select(Tamano_Grupo) %>%
  mutate(across(c(Tamano_Grupo),
                as.character)
          )

# Convertir a formato largo
df_long <- df_long %>%
  pivot_longer(cols = everything(),
  names_to = "Variable", values_to = "Categoria")

# Calcular proporciones
df_prop <- df_long %>%
  group_by(Variable, Categoria) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  group_by(Variable) %>%
  mutate(Proporcion = Frecuencia / sum(Frecuencia))

# Gráfico de barras con facetas
ggplot(df_prop, aes(x = Categoria, y = Proporcion, fill = Categoria)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Variable, scales = "free", ncol=3) +
  geom_text(aes(label = scales::percent(Proporcion, accuracy = 0.1)), 
            vjust = -0.5, size = 3) +
  theme_light() +
  theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 1)
    )
```

**Hallazgos del Análisis de Variables Cualitativas:**

  - Dominio de Grupos Pequeños: La mayoría de las observaciones en el dataset corresponden a grupos de viaje pequeños. Se puede observar que los grupos de 1 o 2 personas son los más frecuentes en la muestra, representando la mayor proporción de los datos.

  - Frecuencia Decreciente: A medida que el tamaño del grupo aumenta, su frecuencia en el dataset disminuye significativamente. Los grupos de 5 o 6 personas son considerablemente menos comunes.

  - Relevancia para el Modelo: Este análisis exploratorio es crucial, ya que la variable Tamano_Grupo es un factor clave en el modelo de regresión multinomial. La distribución de esta variable indica que el modelo tendrá más información para estimar la probabilidad de elección de transporte para grupos pequeños que para grupos grandes.

### **1.3. Análisis bivariado**
```{r bivariado, echo=FALSE}

cat("\n")
df_long = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar,
                Modo_Viaje)


df_long <- df_long %>%
  pivot_longer(cols = c(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar),
               names_to = "Variable",
               values_to = "Valor")

# Crear el gráfico de boxplots
boxplots = ggplot(df_long, aes(x = Variable, y = Valor, fill = Modo_Viaje)) +
geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Distribución de las variables numéricas con el Modo de transporte")
boxplots
```

**Hallazgos del Análisis Bivariado:**

  - Relación Costo-Tiempo vs. Modo de Viaje: Los boxplots muestran que los viajeros que eligen avión tienen los costos más altos y los tiempos más cortos, mientras que los que eligen carro tienen los costos más bajos y los tiempos más largos. Esto es consistente con la idea de que los viajeros balancean el costo y la eficiencia.

  - Impacto de los Ingresos: Los ingresos del hogar son notablemente más altos para quienes eligen el avión, lo que sugiere que una mayor capacidad económica se asocia con una preferencia por opciones de viaje más rápidas.

  - Problema de Multicolinealidad: La matriz de correlación  revela una correlación extremadamente alta entre Costo_Generalizado y Tiempo_Viaje (r>0.9). Para evitar sesgos en el modelo, el Costo_Generalizado debe ser eliminado del análisis de regresión

```{r correlacion, echo=FALSE}
df_sel = df %>%
  dplyr::select(Tiempo_Espera,
                Costo_Viaje,
                Tiempo_Viaje,
                Costo_Generalizado,
                Ingresos_Hogar)

# Calcula la matriz de correlación
corr_matrix = round(cor(df_sel), 2)

ggcorrplot(corr_matrix,
  lab = TRUE,             # Muestra los coeficientes de correlación en el gráfico
  type = "lower",         # Muestra solo la matriz triangular inferior
  outline.col = "white",  # Color del borde de los cuadrados
  ggtheme = ggplot2::theme_gray, # Tema de ggplot
  colors = c("#6D9EC1", "white", "#E46726") # Colores para correlaciones negativas, cero y positivas
) +
labs(title = "Matriz de Correlación")
```

**Hallazgos de la Matriz de Correlación:**

  - Multicolinealidad Crítica: El hallazgo más importante es la correlación casi perfecta entre el Costo_Generalizado y el Tiempo_Viaje. Esta relación, cercana a 1, confirma una multicolinealidad severa. Por lo tanto, el Costo_Generalizado debe ser excluido del modelo de regresión para evitar estimaciones sesgadas y una interpretación incorrecta de los resultados.

  - Relaciones Intuitivas: Existe una correlación moderada entre Costo_Viaje y Tiempo_Espera (r=0.63). Esto tiene sentido, ya que los viajes más costosos (como los vuelos) suelen requerir más tiempo de espera en la terminal.

  - Ausencia de Correlaciones Fuertes: Fuera de la multicolinealidad detectada, no hay otras correlaciones fuertes entre las variables. Esto es positivo, ya que permite que el modelo estime los efectos individuales de cada variable de manera más limpia.

```{r categoricas, echo=FALSE, message=FALSE}
barplots = ggplot(df, aes(x = Tamano_Grupo, fill = Modo_Viaje)) +
  geom_bar(position = "stack") +
  theme_minimal() +
  labs(title = "Relación entre Tamaño del grupo y Modo de transporte",
       x = "Tamaño del grupo",
       y = "Frecuencia")
barplots
```

**Hallazgos Clave de la Relación entre Tamaño del grupo y Modo de transporte:**

  - El Carro domina para grupos grandes: El hallazgo más significativo es que, a medida que el tamaño del grupo aumenta, el carro se convierte en el modo de transporte abrumadoramente predominante. Esto se debe a la eficiencia logística y la reducción del costo por persona.

  - Avión y Tren para grupos pequeños: El avión y el tren son opciones más populares para grupos de una o dos personas. La frecuencia de estas opciones disminuye drásticamente a medida que el grupo se hace más grande, lo que sugiere que son menos atractivas o más costosas para viajes en grupo.

  - El Bus es una opción de nicho: El bus tiene una presencia relativamente baja en todos los tamaños de grupo, lo que lo posiciona como una opción menos preferida en comparación con las demás.

## **2. Modelo multinomial**
```{r modelo, fig.width=10, fig.height=10, echo=FALSE}
df = df_sel = df %>%
  dplyr::select(Costo_Viaje,
                Tiempo_Viaje,
                Ingresos_Hogar,
                Tamano_Grupo,
                Modo_Viaje)
modelo = multinom(Modo_Viaje ~ ., data = df)

# Coeficientes
cat("\nCoefientes")
summary(modelo)$coefficients

# Valores p
cat("\nP-values")
z = summary(modelo)$coefficients/summary(modelo)$standard.errors
p = (1 - pnorm(abs(z), 0, 1)) * 2
p
```

### **2.1. Análisis de los coeficientes y p-values**

Se estima el modelo con las variables predictoras Costo_Viaje, Tiempo_Viaje, Ingresos_Hogar y Tamano_Grupo, y Avión como la categoría base. Sale del summary del modelo, tener en cuenta el p-value

### **2.2. Odds Ratio**
```{r odds, fig.width=10, fig.height=10, echo=FALSE}
odds = exp(coef(modelo))
odds
```

**Hallazgos del Modelo**

Los coeficientes y Odds Ratios nos permiten entender el impacto de cada variable en la elección del modo de viaje en comparación con el avión.

  - Costo de Viaje: Por cada dólar adicional en el costo, las odds de elegir Tren sobre Avión disminuyen en un 24%. Este patrón se repite para Bus y Carro, lo que indica que a medida que el viaje se encarece, las personas son más propensas a elegir el Avión, que ya se considera la opción más cara.

  - Ingresos del Hogar: Por cada mil dólares adicionales en los ingresos, las odds de elegir Carro sobre Avión disminuyen en un 6%. Esto sugiere que a mayor ingreso, las personas se inclinan más por el transporte aéreo, quizás valorando más el tiempo que el costo.

  - Tamaño del Grupo: Por cada persona adicional en el grupo de viaje, las odds de elegir Carro sobre Avión aumentan significativamente (OR=2.68). Esto es intuitivo, ya que el costo por persona en un carro disminuye a medida que el grupo crece.

### **2.3. Análisis marginal**
```{r marginal, echo=FALSE}
marginals = avg_slopes(modelo)
kable(marginals, format = "html", caption = "Análisis marginal", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, position = "center")
```

**Hallazgos del Análisis Marginal:**

Un aumento de un dólar en el Costo_Viaje reduce la probabilidad de elegir Carro en 0.007, mientras que la aumenta para Avión en 0.008. Esto confirma la sensibilidad al costo.

A mayor Ingresos_Hogar, la probabilidad de elegir Avión aumenta, mientras que la de Carro disminuye.

### **2.4. Análisis de las predicciones**

```{r analisis_probs1, echo=FALSE}
vector_cv <- seq(from = min(df$Costo_Viaje, na.rm = TRUE),
                   to = max(df$Costo_Viaje, na.rm = TRUE),
                   length.out = 41)

vector_tv <- seq(from = min(df$Tiempo_Viaje, na.rm = TRUE),
                   to = max(df$Tiempo_Viaje, na.rm = TRUE),
                   length.out = 41)

vector_ing <- seq(from = min(df$Ingresos_Hogar, na.rm = TRUE),
                   to = max(df$Ingresos_Hogar, na.rm = TRUE),
                   length.out = 41)

df_sim <- data.frame(
  Tamano_Grupo = rep(c(1, 2, 3, 4, 5, 6), each = 41),
  Costo_Viaje = rep(vector_cv, 6),
  Tiempo_Viaje = rep(vector_tv, 6),
  Ingresos_Hogar = rep(vector_ing, 6)
)

df_sim$Tamano_Grupo = factor(
  df_sim$Tamano_Grupo,
  ordered=TRUE
)

## almacene las probabilidades predichas para cada valor de tamaño de grupo
pp.sim = cbind(df_sim, predict(modelo, newdata = df_sim, type = "probs", se = TRUE))

## calcular las probabilidades medias dentro de cada nivel de tamaño de grupo
cat("Probabilidades medias por cada nivel de tamaño de grupo")
by(pp.sim[, 5:8], pp.sim$Tamano_Grupo, colMeans)
```

**Hallazgos Clave de las Predicciones por Costo de Viaje:**

  - Los gráficos de probabilidades predichas revelan que el costo del viaje es un factor determinante en la elección del modo de transporte, con efectos opuestos en las opciones de viaje.

  - Impacto Negativo en Opciones Terrestres: A medida que el costo del viaje aumenta, la probabilidad de elegir el Carro, el Bus o el Tren disminuye de forma constante. Este hallazgo confirma que los viajeros son sensibles al precio y tienden a evitar las opciones más económicas cuando estas se encarecen.

  - Impacto Positivo en el Transporte Aéreo: Por el contrario, la probabilidad de elegir el Avión aumenta a medida que el costo del viaje se incrementa. Esto se debe a que el avión es la alternativa más costosa del conjunto de datos. El modelo predice que cuando los costos de viaje son elevados (por ejemplo, debido a largas distancias), la probabilidad de que el viajero se decida por la opción aérea es mayor.

### **2.5. Verificación de la Hipótesis IIA**
```{r hipotesis_IIA, iia_small_hsiao, echo=FALSE}
# Convertir a formato largo (mlogit) — aunque no tengas atributos por alternativa
df_mlogit <- mlogit.data(df_sel, choice = "Modo_Viaje", shape = "wide")

# Estimar modelo EQUIVALENTE en mlogit:
modelo_mlogit <- mlogit(Modo_Viaje ~ 1 | Ingresos_Hogar + Tamano_Grupo,
                        data = df_mlogit,
                        method = "nr",  
                        print.level = 0) 

# Realizar la prueba de IIA con iia()
#iia_test_results <- iia(modelo_mlogit)

# Mostrar los resultados
#print(iia_test_results)
```

Poner hallazgos

```{r analisis_probs2, echo=FALSE}
# Grafico probabilidades predichasCosto_Viaje
# Pasar la base a formato long para utilizar ggplot
cat("Gráfico de probabilidades")
lpp = melt(
  pp.sim,
  id.vars = c("Tamano_Grupo", "Costo_Viaje", "Tiempo_Viaje", "Ingresos_Hogar"),
  value.name = "probability"
)

ggplot(lpp, aes(x = Costo_Viaje, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Costo de Viaje")

ggplot(lpp, aes(x = Tiempo_Viaje, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Tiempo de Viaje")

ggplot(lpp, aes(x = Ingresos_Hogar, y = probability, colour = Tamano_Grupo)) +
  geom_line() +
  facet_grid(variable ~ ., scales = "free") +
  labs(title="Ingresos del hogar")
```

**Hallazgos Grafico probabilidades predichasCosto_Viaje**

  - Relación Inversa para el Carro, Tren y Bus: La probabilidad de elegir el Carro, el Bus o el Tren muestra una clara relación inversa con el Costo_Viaje. A medida que el costo del viaje aumenta, la probabilidad de que un individuo elija cualquiera de estas tres opciones disminuye de forma constante. Este hallazgo es intuitivo: los viajeros son sensibles al precio y prefieren opciones más baratas.

  - Relación Directa para el Avión: En contraste, la probabilidad de elegir el Avión tiene una relación directa con el Costo_Viaje. A medida que el costo aumenta, la probabilidad de elegir el Avión también se incrementa. Este resultado, aunque pueda parecer contraintuitivo a primera vista, se explica por el hecho de que, en el contexto de este conjunto de datos, el Avión es la alternativa de viaje más costosa. El modelo reconoce que, si un viaje tiene un costo elevado (por ejemplo, debido a la distancia), es más probable que la elección sea el Avión que un viaje en Carro o Bus.

  - Impacto del Tamaño del Grupo: La faceta por Tamano_Grupo revela que la sensibilidad al costo varía según el número de viajeros. Se puede observar que para grupos más grandes, la probabilidad de elegir el Carro se mantiene relativamente alta incluso con un aumento en el costo, lo que sugiere que el costo por persona sigue siendo más atractivo. Por el contrario, los grupos pequeños son más propensos a cambiar de opción a medida que el costo aumenta.

### **2.6. Diagnóstico**
```{r diagnostico, echo=FALSE}

# 1. Pseudo R² (McFadden)
logLik_null = logLik(multinom(Modo_Viaje ~ 1, data = df))
logLik_modelo = logLik(modelo)
pseudo_r2 = 1 - (as.numeric(logLik_modelo) / as.numeric(logLik_null))
cat("Pseudo R²:", pseudo_r2, "\n")

# 2. Log-likelihood
cat("Log-likelihood:", logLik_modelo, "\n")

# 3. AIC y BIC
cat("AIC:", AIC(modelo), "\n")
cat("BIC:", BIC(modelo), "\n")


# 4. Matriz de confusión
cat("Matriz de confusión:")
predicciones = predict(modelo)
reporte = confusionMatrix(predicciones, df$Modo_Viaje)
matriz_confusion = reporte$table
matriz_df = melt(matriz_confusion)

# Visualización con ggplot2
ggplot(matriz_df, aes(x = Prediction, y = Reference, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value), size = 5) +
  scale_fill_gradient(low = "lightblue", high = "blue") +
  labs(title = "Matriz de Confusión - Modelo Multinomial",
       x = "Predicho", y = "Real") +
  theme_minimal()

# 5. Reporte de clasificación
cat("\nReporte de clasificación:")
kable(reporte$overall, caption = "Estadísticas generales") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

kable(t(reporte$byClass), caption = "Estadisticas por clase") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

**Hallazgos Clave:**

El Pseudo R2 de McFadden de 0.384 indica un ajuste del modelo moderadamente bueno, ya que valores entre 0.2 y 0.4 son considerados satisfactorios para modelos de elección discreta. Esto significa que las variables predictoras explican una parte significativa de la variabilidad en la elección del modo de viaje.

La tasa de acierto global del modelo es del 77.14%, lo que demuestra una buena capacidad predictiva. Sin embargo, el modelo es particularmente efectivo para predecir las categorías más frecuentes (Avión y Carro), mientras que tiene un rendimiento menor para Bus y Tren.