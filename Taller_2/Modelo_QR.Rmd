---
title: "Taller 2 - Modelo Regresión Cuantílica"
author:
  - name: "Jhon Tascon"
  - name: "Lino Sinisterra"
  - name: "Juan Chacon"
date: "2025-09-08"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(dplyr)
library(ggplot2)
library(caret)
library(class)
library(tidyverse)
library(plotly)
library(ggcorrplot)
library("easypackages")
library(quantreg)
library(broom)
library(purrr)
```

## **0. Información general**

Este trabajo consiste identificar un caso real donde el interés esté en colas de la distribución (poblaciones muy vulnerables o muy favorecidas) y mostrar cómo la regresión cuantil (QR) revela patrones que el promedio (OLS) oculta.

En este caso, haremos el ejercicio con el dataset "Evaluación de la polución y calidad del aire" de kaggle: https://www.kaggle.com/datasets/mujtabamatin/air-quality-and-pollution-assessment. Este dataset se enfoca en envaluaciones de la calidad de aire en varias regiones del mundo. El dataset contiene 5000 muestras y caputra facotres ambientales y demográficos que influyen en los niveles de polución.

La pregunta de investigación es: ¿Cómo influyen los facotres meteorológicos, de densidad de población y cercanía a zonas industriales los diferentes niveles de CO?

## **1. Análisis exploratorio**

Las variables a analizar son las siguientes:

- Temperatura (°C): Temperatura media de la región
- Humedad (%): Humedad relativa registrada en la región
- Concentración PM2.5 (µg/m³): Niveles de partículas finas 
- Concentración de PM10 (µg/m³): Niveles de partículas gruesas -> no se trabajará en el estudio
- Concentración de NO2 (ppb): Niveles de dióxido de nitrógeno -> no se trabajará en el estudio
- Concentración de SO2 (ppb): Niveles de dióxido de azufre -> no se trabajará en el estudio
- Cercanía a Zonas Industriales (km): Distancia a la zona industrial más cercana
- Densidad de población (personas/km²): Número de personas por kilómetro cuadrado en la región
- Calidad del aire: niveles de calidad del aire (Bueno, Moderado, Pobre, Peligroso)
- **Concentración de CO (ppm): Niveles de monóxido de carbono -> Variable objetivo**

Los percentiles a trabajar serán: 0.05, 0.25, 0.50, 0.75 y 0.95

A continuación, se hace un análisis exploratorio de los datos:

```{r echo=FALSE}
df = read.table("updated_pollution_dataset.csv", sep=",", header=T, dec=".")

# Seleccionamos las variables
df = df %>%
  dplyr::select(Temperature, Humidity, PM2.5, CO, Proximity_to_Industrial_Areas,
  Population_Density, Air.Quality
)

# Modificar nombre de las coliumnas
names(df) <- c(
  "Temperatura", "Humedad", "PM2.5", "CO", "Cercania_Areas_Industriales",
  "Densidad_Poblacion", "Calidad_Aire"
)

cat("Visualización de los 10 primeros registros del conjunto de datos:")
knitr::kable(head(df, 10), "pipe")

df$Calidad_Aire = factor(
  df$Calidad_Aire,
  levels=c("Good", "Moderate", "Poor", "Hazardous"),
  ordered=TRUE
)
```

### **Análisis univariado**

```{r echo=FALSE}
# Visualización Univariada de datos
Resumen= summary(df)
knitr::kable(Resumen, "pipe")
```

#### **Distribución de las variables numéricas**

```{r echo=FALSE, message=FALSE}
cat("\n")
# Crear boxplots con facetas
df_long = df %>%
  dplyr::select(Temperatura, Humedad, PM2.5, CO, Cercania_Areas_Industriales, Densidad_Poblacion)

df_long = pivot_longer(
  df_long,
  cols = c(Temperatura, Humedad, PM2.5, CO, Densidad_Poblacion),
  names_to = "Variable",
  values_to = "Valor"
)

boxplots = ggplot(df_long, aes(y = Valor, fill = Variable)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  theme_light() +
  theme(legend.position = "none")
boxplots
```

Puntos Clave:


#### **Distribución de las variables categóricas**
```{r echo=FALSE, message=FALSE}
cat("\n")

# Calcular proporciones
df_prop = df %>%
  group_by(Calidad_Aire) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  mutate(Proporcion = Frecuencia / sum(Frecuencia))


# Gráfico de barras con facetas
ggplot(df_prop, aes(x = Calidad_Aire, y = Proporcion, fill = Calidad_Aire)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = scales::percent(Proporcion, accuracy = 0.1)), 
            vjust = -0.5, size = 3) +
  theme_light() +
  theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

Puntos Clave:


## **2. Modelo de regresión cuantílica**

### **2.1. Modelo OLS**

```{r echo=FALSE}
# Modelo OLS
ols = lm(CO ~ ., data = df)
summary(ols)
```

Interpretar

### **2.2. Modelo QR**
```{r echo=FALSE, warning=FALSE}
# Modelo QR
taus <- c(0.05, 0.25, 0.5, 0.75, 0.95)
qr_fits <- rq(CO ~ ., tau = taus, data = df)
summary(qr_fits, se = "boot")
```

Interpretar

### **2.3. Resultados gráficos**
```{r echo=FALSE, warning=FALSE}
# Vector de cuantiles
G <- seq(0.05, 0.95, by = 0.05)

# Variables a graficar
coef_keep <- c(
  "Temperatura", "Humedad", "PM2.5", "CO", "Cercania_Areas_Industriales",
  "Densidad_Poblacion", "Calidad_Aire.L"
)

# Ajuste QR
qr_fit = quantreg::rq(CO ~ ., tau = G, data = df)

# Coefs OLS para la línea discontinua
ols_coef <- broom::tidy(ols) |>
  dplyr::filter(term %in% c("(Intercept)", coef_keep)) |>
  dplyr::transmute(term, ols = estimate)

# Coefs QR con IC (95%). se.type = "nid" es rápido y estándar.
# Si quieres bootstrap: se.type="boot", R=500, bsmethod="xy"
prof_ci <- broom::tidy(
  qr_fit,
  se.type   = "boot",
  conf.int  = TRUE,
  conf.level= 0.95
) |>
  dplyr::filter(term %in% coef_keep) |>
  dplyr::left_join(ols_coef, by = "term")

ggplot(prof_ci, aes(tau, estimate)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.15) +
  geom_line() + geom_point() +
  geom_hline(aes(yintercept = ols), linetype = "dashed") +
  facet_wrap(~ term, scales = "free_y") +
  labs(title = "QR vs OLS con IC (banda 95%)", x = "τ", y = "Estimación")
```

Interpretar

### **2.4. Modelo QR con interacción**
```{r echo=FALSE, warning=FALSE}
# Modelo con interacción
taus = c(0.05, 0.5, 0.95)

# Aplicamos el modelo con la interacción
fits = lapply(taus, function(t) quantreg::rq(CO ~ Temperatura * Calidad_Aire, tau = t, data = df))

# Malla de predicción por grupo
xg = dplyr::tibble(Temperatura = seq(min(df$Temperatura), max(df$Temperatura), length.out = 200))
newGood = dplyr::mutate(xg, Calidad_Aire = "Good")
newMod = dplyr::mutate(xg, Calidad_Aire = "Moderate")
newPoor = dplyr::mutate(xg, Calidad_Aire = "Poor")
newH = dplyr::mutate(xg, Calidad_Aire = "Hazardous")

pred = dplyr::bind_rows(lapply(seq_along(fits), function(i){
  dplyr::bind_rows(
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(fits[[i]], newGood), tau = paste0("τ=",taus[i]), Calidad_Aire="Good"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(fits[[i]], newMod), tau = paste0("τ=",taus[i]), Calidad_Aire="Moderate"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(fits[[i]], newPoor), tau = paste0("τ=",taus[i]), Calidad_Aire="Poor"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(fits[[i]], newH), tau = paste0("τ=",taus[i]), Calidad_Aire="Hazardous")
  )
}))

# OLS por grupo (comparación)
ols = lm(CO ~ Temperatura * Calidad_Aire, data = df)
pred_ols <- dplyr::bind_rows(
  dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(ols, newGood), tau = "OLS", Calidad_Aire="Good"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(ols, newMod), tau = "OLS", Calidad_Aire="Moderate"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(ols, newPoor), tau = "OLS", Calidad_Aire="Poor"),
    dplyr::tibble(Temperatura = xg$Temperatura, CO = predict(ols, newH), tau = "OLS", Calidad_Aire="Hazardous")
)

ggplot(df, aes(Temperatura, CO, color = Calidad_Aire)) +
  geom_point(alpha = .25) +
  geom_line(data = pred, aes(Temperatura, CO, linetype = tau), linewidth = 1) +
  geom_line(
    data = pred_ols,
    aes(Temperatura, CO, group = Calidad_Aire),   # dos líneas (H y M)
    inherit.aes = FALSE,              # no hereda color = grupo
    color = "black",                  # color distinto para OLS
    linetype = "longdash",
    linewidth = .9
  ) +
  scale_color_discrete(name = "Calidad Aire") +
  scale_linetype_discrete(name = "Cuantil") +
  labs(title = "Cuantiles condicionales con dummy e interacción",
       subtitle = "Líneas sólidas: τ=0.05, 0.5, 0.95 por calidad de aire | Discontinua: OLS por grupo",
       x = "Temperatura", y = "CO") +
  theme_minimal(base_size = 12)
```

Interpretar